= Sync =

The Python Sync Server is composed of four parts:

* ''server-core'': library containing various helpers. 
* ''server-storage'': the storage server. 
* ''server-reg'': the user registration/management server.
* ''server-full'': a server that reunites the server and the user servers so
you can run everything in a single box.


== Prerequisites ==

The various parts are using Python 2.6 and ''virtualenv''. Make sure your
system have them. Or install them:

* [http://python.org/download/releases/2.6.6 Python 2.6 downloads] 
* [http://pypi.python.org/pypi/virtualenv Virtualenv]

To run the server, you will also need to have these packages installed:

* python-dev
* make
* mercurial
* python-profiler (Debuntu)
* sqlite3 (if you use SQLite -- default)


== Building the full server ==

It is recommended to install the full server. Get the latest version at
https://hg.mozilla.org/services/server-full and run this command:

  $ make build

This command will create an isolated Python environment and pull all the
required dependencies in it. A ''bin'' directory is created and contains a
'''paster'' command that can be used to run the server, using the built-in web
server. 

Running options are kept in an ini-like file that is passed to the
command:

  $ bin/paster serve development.ini 
  Starting server in PID 29951. 
  serving on 0.0.0.0:5000 view at http://127.0.0.1:5000

By default the server is configured to use a SQLite database for the storage
and the user APIs. Once the server is launched, you can point your Firefox Sync
to "http://localhost:5000" and make sure it works.

=== Using MYSQL or LDAP or ... ===

Instead of SQLite, you can use alternative backends:

- Open-LDAP to store the users
- A SQLAlchemy-compatible database, to store the sync data and/or the users

Sync has been tested on MySQL and Postgres.

In order to use a specific Database, you need to install the required
headers, and the required Python library in the local Python environment.

See http://www.sqlalchemy.org/docs/core/engines.html#supported-dbapis

For example, to run everything in MySQL:

1 - install libmysqlclient-dev and mysql-server
2 - install Mysql-Python by running "bin/easy_install Mysql-Python"
3 - change the configuration file located at etc/sync.conf

For #3, see http://docs.services.mozilla.com/configuration.html#configuration-file


== Deploying ==

The built-in server is not to be used if you want to set up a production 
server. You can use different web servers that are compatible with the 
implementation (WSGI-based):

Examples:
- Apache + mod_wsgi
- NGinx + Gunicorn
- lighttpd + flup + fcgi


=== Running behind Apache ===

Here's an example of an Apache setup that uses it:

  <Directory /path/to/sync>
    Order deny,allow
    Allow from all
  </Directory>

  <VirtualHost *:80>
    ServerName example.com
    DocumentRoot /path/to/sync
    WSGIProcessGroup sync
    WSGIDaemonProcess sync user=sync group=sync processes=2 threads=25
    WSGIPassAuthorization On
    WSGIScriptAlias / /path/to/sync/sync.wsgi
    CustomLog /var/log/apache2/example.com-access.log combined
    ErrorLog  /var/log/apache2/example.com-error.log
  </VirtualHost>

This configuration will use the sync.wsgi file located in the project. Make 
sure this file loads the right .ini file.

=== Running behind lighttpd/fcgi ===

Tested under Gentoo.


1. Make sure you have the following packeages installed: 

- flup
- virtualenv
- mercurial

With gentoo use: emerge -avuDN flup virtualenv mercurial

2. Unpack the server-full python version lets say under /usr/src/sync-full

3. make build ; /usr/src/sync-full/bin/easy_install flup

4. I had to edit the Makefile to take out the memcache dependency. YMMV.

5. Edit development.ini:

    [server:main]
    use = egg:Flup#fcgi_thread
    host = 0.0.0.0
    port = 5000

6. Edit conf/sync.ini:

    [storage]
    backend = sql
    sqluri = sqlite:////usr/src/sync-full/weave_storage
    standard_collections = false

    [auth]
    backend = sql
    sqluri = sqlite:////usr/src/sync-full/weave_user
    pool_size = 100
    pool_recycle = 3600
    create_tables = true
    fallback_node = https://www.yourserver.net/yourpath/

7. Edit your lighttpd.conf:

    server.modules   += ( "mod_fastcgi" )
    fastcgi.server    = (   "/yourpath" => ((
                            "host" => "127.0.0.1",
                            "port" => 5000,
                    "idle-imeout" => 32,
                    "check-local" => "disable",
                    "disable-time" => 1,
                    "fix-root-scriptname" => "enable"
                    ))
                )

8. Start the Python server

    /usr/src/sync-full/paster serve /usr/src/sync-full/development.ini --daemon

9. Restart your lighttpd:

    /etc/init.d/lighttpd restart


=== Running behind NGinx ===

XXX


== More documentation, Feedback ==

- Dev guide: http://docs.services.mozilla.com
- IRC channel: #sync. See http://irc.mozilla.org/
- Mailing list: https://mail.mozilla.org/admin/services-dev



